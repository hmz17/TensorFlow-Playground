This is the code from https://gist.github.com/martinwicke/6838c23abdc53e6bcda36ed9f40cff39
